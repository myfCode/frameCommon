(function(){var j=!!("ontouchstart" in window),c=j?"touchstart":"mousedown",k=j?"touchend":"mouseup",i=j?"touchmove":"mousemove",a=function(){},l={};function b(u){var q=u.holder,r=u.option,o=r.matrix,t=r.margin,n=r.radius;linewidth=r.linewidth;html=['<ul class="patt-wrap" style="padding:'+t+'px">'];for(var p=0,s=o[0]*o[1];p<s;p++){html.push('<li class="patt-circ" style="margin:'+t+"px; width : "+(n*2)+"px; height : "+(n*2)+"px; -webkit-border-radius: "+n+"px; -moz-border-radius: "+n+"px; border-radius: "+n+'px; "><div class="patt-dots"></div></li>')}html.push("</ul>");q.html(html.join("")).css({"width":(o[1]*(n*2+t*2)+t*2)+"px","height":(o[0]*(n*2+t*2)+t*2)+"px"});u.pattCircle=u.holder.find(".patt-circ")}function d(o,n,r,p){var s=n-o,q=p-r;return{length:Math.ceil(Math.sqrt(s*s+q*q)),angle:Math.round((Math.atan2(q,s)*180)/Math.PI)}}var e=function(q,p){q.preventDefault();var o=l[p.token];if(!o.option.patternVisible){o.holder.addClass("patt-off")}$(this).on(i+".pattern-move",function(s){g.call(this,s,p)});$(document).one(k,function(){h.call(this,q,p)});var n=o.holder.find(".patt-wrap"),r=n.offset();o.wrapTop=r.top,o.wrapLeft=r.left;p.reset()},g=function(D,v){D.preventDefault();$.settouch.init(D);var s=$.touchX,r=$.touchY,t=l[v.token],w=t.pattCircle,B=t.patternAry,F=t.option.lineOnMove,n=t.getIdxFromPoint(s,r),z=n.idx,C=t.mapperFunc(z)||z;if(B.length>0){var G=d(t.lineX1,n.x,t.lineY1,n.y);t.line.css({"width":(G.length+linewidth)+"px","transform":"rotate("+G.angle+"deg)"})}if(z){if(B.indexOf(C)==-1){var p=$(w[z-1]);p.addClass("hovered");B.push(C);t.option.onEach(C);var A=t.option.margin,o=t.option.radius,E=(n.i-1)*(2*A+2*o)+2*A+o;newY=(n.j-1)*(2*A+2*o)+2*A+o;if(B.length!=1){var q=d(t.lineX1,E,t.lineY1,newY);t.line.css({"width":(q.length+linewidth)+"px","transform":"rotate("+q.angle+"deg)"});if(!F){t.line.show()}}var u=$('<div class="patt-lines" style="top:'+(newY-(linewidth/2))+"px; left:"+(E-(linewidth/2))+'px"></div>');t.line=u;t.lineX1=E;t.lineY1=newY;t.holder.append(u);if(!F){t.line.hide()}}}},h=function(r,q){r.preventDefault();var p=l[q.token],n=p.pattCircle,o=p.patternAry.join("");p.holder.off(".pattern-move");if(!o){return}p.option.onDraw(o);p.line.remove();if(p.rightPattern){if(o==p.rightPattern){p.onSuccess()}else{p.onError();q.error()}}};function m(){}m.prototype={constructor:m,getIdxFromPoint:function(t,r){var p=this.option,s=p.matrix,q=t-this.wrapLeft,o=r-this.wrapTop,u=null,n=p.margin,v=p.radius*2+n*2;qsntX=Math.ceil(q/v),qsntY=Math.ceil(o/v),remX=q%v,remY=o%v;if(qsntX<=s[1]&&qsntY<=s[0]&&remX>n*2&&remY>n*2){u=(qsntY-1)*s[1]+qsntX}return{idx:u,i:qsntX,j:qsntY,x:q,y:o}}};function f(n,r){var o=this,q=o.token=Math.random(),s=l[q]=new m(),p=s.holder=$(n);if(p.length==0){return}s.object=o;r=s.option=$.extend({},f.defaults,r);b(s);p.addClass("patt-holder");if(p.css("position")=="static"){p.css("position","relative")}p.on(c,function(u){e.call(this,u,o)});s.option.onDraw=r.onDraw||a;s.option.onEach=r.onEach||a;var t=r.mapper;if(typeof t=="object"){s.mapperFunc=function(u){return t[u]}}else{if(typeof t=="function"){s.mapperFunc=t}else{s.mapperFunc=a}}s.option.mapper=null}f.prototype={constructor:f,option:function(n,q){var p=l[this.token],o=p.option;if(!q){return o[n]}else{o[n]=q;if(n=="margin"||n=="matrix"||n=="radius"){b(p)}}},getPattern:function(){return l[this.token].patternAry.join("")},reset:function(){var n=l[this.token];n.pattCircle.removeClass("hovered");n.holder.find(".patt-lines").remove();n.patternAry=[];n.holder.removeClass("patt-error")},error:function(){l[this.token].holder.addClass("patt-error")},checkForPattern:function(o,q,n){var p=l[this.token];p.rightPattern=o;p.onSuccess=q||a;p.onError=n||a}};f.defaults={matrix:[3,3],margin:10,radius:50,linewidth:10,patternVisible:true,lineOnMove:true};window.PatternLock=f}());